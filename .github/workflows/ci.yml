name: UiPath CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    - name: üì¶ Checkout code
      uses: actions/checkout@v4

    - name: üìÇ Cr√©er dossiers n√©cessaires
      shell: powershell
      run: |
        mkdir copa\uipcli
        mkdir copa\output

    - name: üîß T√©l√©charger l'ancien UiPath CLI depuis MyGet
      shell: powershell
      run: |
        nuget install UiPath.CLI.Windows -Version 1.0.7985.19721 `
          -OutputDirectory "./copa/uipcli" `
          -Source "https://www.myget.org/F/uipath-dev/api/v3/index.json"

    - name: üì¶ Pack UiPath Project
      shell: powershell
      run: |
        ./copa/uipcli/UiPath.CLI.Windows.1.0.7985.19721/tools/uipcli.exe project pack `
          --input-folder ./copa `
          --output-folder ./copa/output `
          --debug

    - name: üìÅ V√©rifie que le package a bien √©t√© g√©n√©r√©
      shell: powershell
      run: |
        if ((Get-ChildItem ./copa/output/*.nupkg -ErrorAction SilentlyContinue).Count -eq 0) {
          Write-Error "‚ùå Aucun package g√©n√©r√© dans ./copa/output"
        } else {
          Write-Host "‚úÖ Package g√©n√©r√© avec succ√®s"
        }

    - name: ‚òÅÔ∏è Upload Package as Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: uipath-package
        path: ./copa/output/*.nupkg

    - name: üîê Authentification Orchestrator
      shell: powershell
      run: |
        ./copa/uipcli/UiPath.CLI.Windows.1.0.7985.19721/tools/uipcli.exe login `
          --client-id "${{ secrets.UIPATH_CLIENT_ID }}" `
          --client-secret "${{ secrets.UIPATH_CLIENT_SECRET }}" `
          --account-name "${{ secrets.UIPATH_ACCOUNT_LOGICAL_NAME }}" `
          --tenant "${{ secrets.UIPATH_TENANT }}" `
          --url "${{ secrets.UIPATH_ORCHESTRATOR_URL }}"

    - name: üöÄ Push Package vers Orchestrator
      shell: powershell
      run: |
        ./copa/uipcli/UiPath.CLI.Windows.1.0.7985.19721/tools/uipcli.exe push `
          ./copa/output/*.nupkg