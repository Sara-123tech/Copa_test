name: UiPath CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    - name: 📦 Checkout code
      uses: actions/checkout@v4

    - name: 🧭 Afficher l'arborescence initiale
      shell: powershell
      run: Get-ChildItem -Recurse

    - name: 🔧 Download and Setup UiPath CLI
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://github.com/UiPath/uipathcli/releases/latest/download/uipathcli-windows-amd64.zip" -OutFile uipcli.zip
        Expand-Archive -Path uipcli.zip -DestinationPath uipcli

    - name: 🔍 Vérifie présence de project.json
      shell: powershell
      run: Get-ChildItem -Recurse -Filter project.json

    - name: 📂 Créer dossier ./output
      shell: powershell
      run: mkdir output

    - name: 📦 Pack UiPath Project
      shell: powershell
      run: ./uipath/uipath.exe project pack --input-folder ./Copa --output-folder ./output --debug

    - name: 📁 Afficher le contenu du dossier ./output (vérification)
      shell: powershell
      run: |
        if (Test-Path "./output") {
          Get-ChildItem ./output -Recurse
        } else {
          Write-Host "⚠️ Le dossier ./output n'existe pas. Le pack a échoué."
          exit 1
        }

    - name: ☁️ Upload Package as Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: uipath-package
        path: ./output/*.nupkg

    - name: 🔐 Authenticate to UiPath Orchestrator
      shell: cmd
      run: |
        .\uipcli\uipath.exe login ^
          --client-id "${{ secrets.UIPATH_CLIENT_ID }}" ^
          --client-secret "${{ secrets.UIPATH_CLIENT_SECRET }}" ^
          --account-name "${{ secrets.UIPATH_ACCOUNT_LOGICAL_NAME }}" ^
          --tenant "${{ secrets.UIPATH_TENANT }}" ^
          --url "${{ secrets.UIPATH_ORCHESTRATOR_URL }}"

    - name: 🚀 Push Package to Orchestrator
      shell: powershell
      run: ./uipcli/uipath.exe push ./output/*.nupkg