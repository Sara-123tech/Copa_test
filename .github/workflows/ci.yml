name: UiPath CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    - name: 📦 Checkout code
      uses: actions/checkout@v4

    - name: 🧰 Install NuGet CLI
      uses: nuget/setup-nuget@v1

    - name: 🔽 Télécharger UiPath CLI depuis le flux officiel
      run: |
        nuget install UiPath.CLI.Windows -Source "https://pkgs.dev.azure.com/uipath/Public.Feeds/_packaging/UiPath-Official/nuget/v3/index.json" -OutputDirectory uipcli

    - name: 📦 Extraire le .nupkg (en renommant .zip)
      shell: powershell
      run: |
          $nupkg = Get-ChildItem -Path ./uipcli -Recurse -Filter *.nupkg | Select-Object -First 1
          $zipPath = "$($nupkg.DirectoryName)\uipcli_temp.zip"
          Copy-Item $nupkg.FullName -Destination $zipPath -Force
          Expand-Archive -Path $zipPath -DestinationPath ./uipcli/cli -Force


    - name: 📂 Créer dossier ./output
      run: mkdir output

    - name: 📦 Pack UiPath Project
      run: |
        ./uipcli/cli/tools/uipcli.exe project pack --input-folder ./copa --output-folder ./output --debug

    - name: 📁 Vérifier contenu du dossier ./output
      shell: powershell
      run: |
        if ((Get-ChildItem ./output/*.nupkg -ErrorAction SilentlyContinue).Count -eq 0) {
          Write-Error "❌ Aucun package généré dans ./output"
          exit 1
        } else {
          Write-Host "✅ Package généré avec succès"
          Get-ChildItem ./output
        }

    - name: ☁️ Upload Package as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: uipath-package
        path: ./output/*.nupkg

    - name: 🔐 Authentification à UiPath Orchestrator
      shell: cmd
      run: |
        ./uipcli/cli/tools/uipcli.exe login ^
          --client-id "${{ secrets.UIPATH_CLIENT_ID }}" ^
          --client-secret "${{ secrets.UIPATH_CLIENT_SECRET }}" ^
          --account-name "${{ secrets.UIPATH_ACCOUNT_LOGICAL_NAME }}" ^
          --tenant "${{ secrets.UIPATH_TENANT }}" ^
          --url "${{ secrets.UIPATH_ORCHESTRATOR_URL }}"

    - name: 🚀 Push Package vers Orchestrator
      run: ./uipcli/cli/tools/uipcli.exe project push --file ./output/*.nupkg
