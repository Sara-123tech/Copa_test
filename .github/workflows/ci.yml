name: UiPath CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¥ TÃ©lÃ©charger UiPath CLI (.nupkg)
      run: |
        Invoke-WebRequest -Uri "https://uipath.pkgs.visualstudio.com/Public.Feeds/_apis/packaging/feeds/UiPath-Official/nuget/packages/UiPath.CLI.Windows/versions/25.4.0/content" -OutFile uipcli.nupkg
      shell: powershell

    - name: ğŸ“¦ Extraire contenu de uipcli.nupkg
      run: |
        mkdir uipcli
        Expand-Archive -Path uipcli.nupkg -DestinationPath uipcli
      shell: powershell

    - name: ğŸ“ CrÃ©er dossier ./output
      run: mkdir output
      shell: powershell

    - name: ğŸ“¦ Pack du projet UiPath
      run: ./uipcli/tools/uipcli.exe automation project pack --input-folder ./copa --output-folder ./output --debug
      shell: powershell

    - name: ğŸ“ VÃ©rifier contenu du dossier ./output
      run: |
        if ((Get-ChildItem ./output/*.nupkg -ErrorAction SilentlyContinue).Count -eq 0) {
          Write-Error "âŒ Aucun package gÃ©nÃ©rÃ© dans ./output"
          exit 1
        } else {
          Write-Host "âœ… Package gÃ©nÃ©rÃ© avec succÃ¨s"
          Get-ChildItem ./output
        }
      shell: powershell

    - name: â˜ï¸ Upload du package comme artefact
      uses: actions/upload-artifact@v4
      with:
        name: uipath-package
        path: ./output/*.nupkg

    - name: ğŸ” Ajouter configuration d'authentification Orchestrator
      run: |
        ./uipcli/tools/uipcli.exe config add --profile ci-profile `
          --account-name "${{ secrets.UIPATH_ACCOUNT_LOGICAL_NAME }}" `
          --client-id "${{ secrets.UIPATH_CLIENT_ID }}" `
          --client-secret "${{ secrets.UIPATH_CLIENT_SECRET }}" `
          --organization "${{ secrets.UIPATH_ORGANIZATION_NAME }}" `
          --tenant "${{ secrets.UIPATH_TENANT }}" `
          --url "${{ secrets.UIPATH_ORCHESTRATOR_URL }}"
      shell: powershell

    - name: ğŸš€ DÃ©ployer le package vers Orchestrator
      run: ./uipcli/tools/uipcli.exe automation deploy --profile ci-profile --package ./output/*.nupkg
      shell: powershell
