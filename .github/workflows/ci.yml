name: UiPath CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Download and Setup UiPath CLI
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://github.com/UiPath/uipathcli/releases/latest/download/uipathcli-windows-amd64.zip" -OutFile uipcli.zip
        Expand-Archive -Path uipcli.zip -DestinationPath uipcli
        echo "$((Get-Location).Path)\uipcli" | Out-File -Append -Encoding ascii $env:GITHUB_PATH

    - name: âœ… Check UiPath CLI version
      run: uipath version

    - name: ğŸ“ Pack UiPath Project
      run: uipath project pack --input-folder . --output-folder ./output

    - name: ğŸ“‚ Liste les fichiers dans output
      run: dir ./output

    - name: â˜ï¸ Upload Package as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: uipath-package
        path: ./output/*.nupkg

    - name: ğŸ” Authenticate to UiPath Orchestrator
      shell: cmd
      run: |
        uipath login ^
          --client-id "%UIPATH_CLIENT_ID%" ^
          --client-secret "%UIPATH_CLIENT_SECRET%" ^
          --account-name "%UIPATH_ACCOUNT_LOGICAL_NAME%" ^
          --tenant "%UIPATH_TENANT%" ^
          --url "%UIPATH_ORCHESTRATOR_URL%"

    - name: ğŸš€ Push Package to Orchestrator
      run: uipath push ./output/*.nupkg
