name: UiPath CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    # 1. RÃ©cupÃ©ration du code
    - name: ğŸ“¦ Checkout repository
      uses: actions/checkout@v4

    # 2. Installation du SDK .NET 6.0 (nÃ©cessaire Ã  UiPath.Vision, UIAutomation 25.x, etc.)
    - name: ğŸ“¥ Setup .NET 6 SDK
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'

    # 3. TÃ©lÃ©chargement et installation du UiPathâ€¯CLI
    - name: ğŸ”§ Download UiPath CLI
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://github.com/UiPath/uipathcli/releases/latest/download/uipathcli-windows-amd64.zip" -OutFile cli.zip
        Expand-Archive -Path cli.zip -DestinationPath uipcli

    # 4. VÃ©rification du contenu racine (debug)
    - name: ğŸ“ Contenu racine du repo
      run: dir .

    # 5. VÃ©rification de la version CLI
    - name: âœ… UiPath CLI version
      run: .\uipcli\uipath.exe version

    # 6. Restauration des packages NuGet UiPath (indispensable)
    - name: ğŸ“¥ Restore UiPath packages
      run: .\uipcli\uipath.exe restore project.json --debug

    # 7. Packaging du projet
    - name: ğŸ“¦ Pack UiPath project
      run: .\uipcli\uipath.exe project pack --input-folder . --output-folder ./output --debug



    # 9. Upload du package comme artefact GitHub
    - name: â˜ï¸ Upload package artefact
      uses: actions/upload-artifact@v4
      with:
        name: uipath-package
        path: ./output/*.nupkg

    # 10. Authentification Orchestrator
    - name: ğŸ” UiPath Orchestrator login
      shell: powershell
      run: |
        .\uipcli\uipath.exe login `
          --client-id "${{ secrets.UIPATH_CLIENT_ID }}" `
          --client-secret "${{ secrets.UIPATH_CLIENT_SECRET }}" `
          --account-name "${{ secrets.UIPATH_ACCOUNT_LOGICAL_NAME }}" `
          --tenant "${{ secrets.UIPATH_TENANT }}" `
          --url "${{ secrets.UIPATH_ORCHESTRATOR_URL }}"

    # 11. Push du package vers Orchestrator
    - name: ğŸš€ Push package to Orchestrator
      run: .\uipcli\uipath.exe push ./output/*.nupkg
