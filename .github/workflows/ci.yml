name: UiPath CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ§­ Afficher l'arborescence initiale
      shell: powershell
      run: Get-ChildItem -Recurse

    - name: ğŸ”§ TÃ©lÃ©charger et dÃ©placer UiPath CLI dans ./copa/uipcli
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://github.com/UiPath/uipathcli/releases/latest/download/uipathcli-windows-amd64.zip" -OutFile "uipcli.zip"
        Expand-Archive -Path "uipcli.zip" -DestinationPath "tempcli"
        New-Item -ItemType Directory -Path "copa/uipcli" -Force
        Copy-Item -Path "tempcli/*" -Destination "copa/uipcli" -Recurse -Force

    - name: ğŸ“‚ CrÃ©er dossier ./copa/output
      shell: powershell
      run: New-Item -ItemType Directory -Force -Path "./copa/output"

    - name: ğŸ“¦ Pack UiPath Project
      shell: powershell
      run: ./copa/uipcli/uipath.exe project pack --input-folder ./copa --output-folder ./copa/output --debug

    - name: ğŸ“ VÃ©rifier contenu du dossier ./copa/output
      shell: powershell
      run: |
        if ((Get-ChildItem ./copa/output/*.nupkg -ErrorAction SilentlyContinue).Count -eq 0) {
          Write-Error "âŒ Aucun package gÃ©nÃ©rÃ© dans ./copa/output"
          exit 1
        } else {
          Write-Host "âœ… Package gÃ©nÃ©rÃ© avec succÃ¨s"
          Get-ChildItem ./copa/output
        }

    - name: â˜ï¸ Upload du package comme artefact
      uses: actions/upload-artifact@v4
      with:
        name: uipath-package
        path: ./copa/output/*.nupkg

    - name: ğŸ” Authentification Ã  Orchestrator
      shell: cmd
      run: |
        .\copa\uipcli\uipath.exe login ^
          --client-id "${{ secrets.UIPATH_CLIENT_ID }}" ^
          --client-secret "${{ secrets.UIPATH_CLIENT_SECRET }}" ^
          --account-name "${{ secrets.UIPATH_ACCOUNT_LOGICAL_NAME }}" ^
          --tenant "${{ secrets.UIPATH_TENANT }}" ^
          --url "${{ secrets.UIPATH_ORCHESTRATOR_URL }}"

    - name: ğŸš€ DÃ©ploiement du package vers Orchestrator
      shell: powershell
      run: ./copa/uipcli/uipath.exe push ./copa/output/*.nupkg
