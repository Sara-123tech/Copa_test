name: UiPath CI Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    - name: üì¶ Checkout du code
      uses: actions/checkout@v4
    
    
    - name: üì• T√©l√©charger UiPath CLI depuis le feed UiPath officiel (MyGet)
      run: |
        nuget install UiPath.CLI.Windows -Version 25.4.9239.19674 `
          -Source https://www.myget.org/F/uipath-dev/api/v3/index.json `
          -OutputDirectory ./cli
      shell: powershell

    - name: üìÇ Lister le contenu de ./cli
      run: |
        Get-ChildItem -Recurse ./cli
      shell: powershell

    - name: üì¶ Packager le projet UiPath
      run: |
        ./cli/UiPath.CLI.Windows.25.4.9239.19674/tools/uipcli.exe automation project pack `
          --input-folder ./copa `
          --output-folder ./output `
          --debug
      shell: powershell

    - name: üìÅ V√©rifier contenu du dossier ./output
      run: |
        if ((Get-ChildItem ./output/*.nupkg -ErrorAction SilentlyContinue).Count -eq 0) {
          Write-Error "‚ùå Aucun package g√©n√©r√© dans ./output"
          exit 1
        } else {
          Write-Host "‚úÖ Package g√©n√©r√© avec succ√®s"
          Get-ChildItem ./output
        }
      shell: powershell

    - name: ‚òÅÔ∏è Upload du package comme artefact
      uses: actions/upload-artifact@v4
      with:
        name: uipath-package
        path: ./output/*.nupkg

    - name: üîê Ajouter configuration d'authentification Orchestrator
      run: |
        ./cli/UiPath.CLI.Windows.25.4.9239.19674/tools/uipcli.exe config add --profile ci-profile `
          --account-name "${{ secrets.UIPATH_ACCOUNT_LOGICAL_NAME }}" `
          --client-id "${{ secrets.UIPATH_CLIENT_ID }}" `
          --client-secret "${{ secrets.UIPATH_CLIENT_SECRET }}" `
          --organization "${{ secrets.UIPATH_ORGANIZATION_NAME }}" `
          --tenant "${{ secrets.UIPATH_TENANT }}" `
          --url "${{ secrets.UIPATH_ORCHESTRATOR_URL }}"
      shell: powershell

    - name: üöÄ D√©ployer le package vers Orchestrator
      run: ./cli/UiPath.CLI.Windows.25.4.9239.19674/tools/uipcli.exe automation deploy --profile ci-profile --package ./output/*.nupkg
      shell: powershell
